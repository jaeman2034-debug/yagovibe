import { useEffect, useMemo, useState } from "react";
import { collection, onSnapshot, orderBy, query, where, limit } from "firebase/firestore";
import { db } from "@/lib/firebase";
import YagoLayout from "@/layouts/YagoLayout";
import { YagoButton, YagoCard, YagoStatCard } from "@/components/ui/YagoComponents";
import dayjs from "dayjs";
import { aggregateLogs } from "@/utils/aggregateLogs";

type Insight = {
    headline: string;
    bullets: string[];
    action: string;
};

export default function Insights() {
    const [raw, setRaw] = useState<any[]>([]);
    const [agg, setAgg] = useState<any>(null);
    const [insight, setInsight] = useState<Insight | null>(null);
    const [loading, setLoading] = useState(false);
    const [slackLoading, setSlackLoading] = useState(false);
    const todayStart = dayjs().startOf("day").toDate();

    // 1) ì˜¤ëŠ˜ ë¡œê·¸ ì‹¤ì‹œê°„ êµ¬ë…
    useEffect(() => {
        const q = query(
            collection(db, "voice_logs"),
            where("ts", ">=", todayStart),
            orderBy("ts", "desc"),
            limit(1000)
        );
        const unsub = onSnapshot(q, (snap) => {
            const arr: any[] = [];
            snap.forEach((d) => arr.push(d.data()));
            setRaw(arr);
        });
        return () => unsub();
    }, []);

    // 2) ì§‘ê³„
    useEffect(() => {
        const loadAggregation = async () => {
            const result = await aggregateLogs();
            setAgg(result);
        };
        loadAggregation();
    }, []);

    // 3) GPT í˜¸ì¶œ â†’ ì¸ì‚¬ì´íŠ¸ ìƒì„±
    const generateInsight = async () => {
        if (!agg) return;
        setLoading(true);
        try {
            const key = import.meta.env.VITE_OPENAI_API_KEY;
            if (!key) {
                alert("OpenAI í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. VITE_OPENAI_API_KEY ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
                setLoading(false);
                return;
            }

            const payload = {
                date: agg.date,
                total: agg.total,
                intents: agg.intents,
                keywords: agg.keywords,
                hours: agg.hours,
                // ì§€ì˜¤ìƒ˜í”Œì€ í† í° ì ˆì•½ì„ ìœ„í•´ 30ê°œë§Œ ì „ì†¡
                geoSample: agg.geoSample.slice(0, 30),
            };

            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        {
                            role: "system",
                            content:
                                "ë„ˆëŠ” ë°ì´í„° ë¶„ì„ ì¸ì‚¬ì´íŠ¸ ìƒì„±ê¸°ì•¼. ì£¼ì–´ì§„ ë¡œê·¸ ìš”ì•½ì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤/ìš´ì˜ ì¸¡ë©´ì˜ í†µì°° 3~5ê°œì™€ ì‹¤í–‰ ì•¡ì…˜ 1ê°œë¥¼ í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë§Œë“¤ì–´ì¤˜. í˜•ì‹ì€ JSONìœ¼ë¡œë§Œ ì¶œë ¥í•´: {\"headline\":\"...\",\"bullets\":[\"...\",\"...\"],\"action\":\"...\"}",
                        },
                        { role: "user", content: JSON.stringify(payload) },
                    ],
                    temperature: 0.3,
                }),
            });

            const data = await res.json();
            const text = data?.choices?.[0]?.message?.content ?? "";

            // ëª¨ë¸ì´ JSONë§Œ ë‚´ë„ë¡ ìš”ì²­í–ˆì§€ë§Œ í˜¹ì‹œ ëŒ€ë¹„
            const parsed = JSON.parse(
                text.trim().replace(/```json/g, "").replace(/```/g, "")
            ) as Insight;

            setInsight(parsed);
        } catch (e) {
            console.error(e);
            alert("ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹¤íŒ¨: " + (e instanceof Error ? e.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        } finally {
            setLoading(false);
        }
    };

    // 4) Slack ê³µìœ  (ì˜µì…˜)
    const shareToSlack = async () => {
        if (!insight || !agg) return;
        setSlackLoading(true);
        try {
            const topIntent = Object.entries(agg.intents).sort((a, b) => (b[1] as number) - (a[1] as number))[0]?.[0] ?? "-";
            const topKeyword = Object.entries(agg.keywords).sort((a, b) => (b[1] as number) - (a[1] as number))[0]?.[0] ?? "-";

            const text =
                `ğŸ§  *YAGO AI ì¸ì‚¬ì´íŠ¸* (${agg.date})\n` +
                `ğŸ“Š ì´ ${agg.total}ê±´ | ìƒìœ„ ì˜ë„: ${topIntent} | ìƒìœ„ í‚¤ì›Œë“œ: ${topKeyword}\n\n` +
                `*${insight.headline}*\n` +
                insight.bullets.map((b) => `â€¢ ${b}`).join("\n") +
                `\n\nâ¡ï¸ *Action:* ${insight.action}\n\n` +
                `_Generated by YAGO VIBE AI System_`;

            // ê°„ë‹¨: Incoming Webhook ì‚¬ìš©
            const webhook = import.meta.env.VITE_SLACK_WEBHOOK_URL || "";
            if (!webhook) {
                alert("Slack Webhookì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní™˜ê²½ ë³€ìˆ˜ VITE_SLACK_WEBHOOK_URLì„ ì„¤ì •í•˜ì„¸ìš”.");
                return;
            }

            await fetch(webhook, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text }),
            });

            alert("âœ… Slack ê³µìœ  ì™„ë£Œ!");
        } catch (e) {
            console.error(e);
            alert("âŒ Slack ê³µìœ  ì‹¤íŒ¨: " + (e instanceof Error ? e.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        } finally {
            setSlackLoading(false);
        }
    };

    // í†µê³„ ê³„ì‚°
    const stats = useMemo(() => {
        if (!agg) return null;

        const topIntent = Object.entries(agg.intents).sort((a, b) => (b[1] as number) - (a[1] as number))[0];
        const topKeyword = Object.entries(agg.keywords).sort((a, b) => (b[1] as number) - (a[1] as number))[0];
        const peakHour = Object.entries(agg.hours).sort((a, b) => (b[1] as number) - (a[1] as number))[0];

        return {
            topIntent: topIntent ? topIntent[0] : "ì—†ìŒ",
            topIntentCount: topIntent ? topIntent[1] : 0,
            topKeyword: topKeyword ? topKeyword[0] : "ì—†ìŒ",
            topKeywordCount: topKeyword ? topKeyword[1] : 0,
            peakHour: peakHour ? peakHour[0] : "ì—†ìŒ",
            peakHourCount: peakHour ? peakHour[1] : 0,
        };
    }, [agg]);

    return (
        <YagoLayout title="AI Insight Generator">
            <div className="space-y-6">
                {/* ğŸ“Š í—¤ë” ì„¹ì…˜ */}
                <div className="text-center">
                    <h1 className="text-4xl font-display font-bold text-yago-purple mb-2">
                        ğŸ§  AI Insight Generator
                    </h1>
                    <p className="text-lg text-yago-gray">
                        GPT-4o-miniê°€ ë¶„ì„í•˜ëŠ” ì‹¤ì‹œê°„ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸
                    </p>
                </div>

                {/* ğŸ“ˆ í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <YagoStatCard
                        title="ì˜¤ëŠ˜ ì´ ë¡œê·¸"
                        value={agg?.total || 0}
                        change="ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸"
                        trend="up"
                        icon="ğŸ“"
                    />
                    <YagoStatCard
                        title="ì¸ê¸° ì˜ë„"
                        value={stats?.topIntent || "ì—†ìŒ"}
                        change={`${stats?.topIntentCount || 0}íšŒ`}
                        trend="neutral"
                        icon="ğŸ¯"
                    />
                    <YagoStatCard
                        title="ì¸ê¸° í‚¤ì›Œë“œ"
                        value={stats?.topKeyword || "ì—†ìŒ"}
                        change={`${stats?.topKeywordCount || 0}íšŒ`}
                        trend="neutral"
                        icon="ğŸ”¥"
                    />
                    <YagoStatCard
                        title="í”¼í¬ ì‹œê°„ëŒ€"
                        value={stats?.peakHour ? `${stats.peakHour}:00` : "ì—†ìŒ"}
                        change={`${stats?.peakHourCount || 0}íšŒ`}
                        trend="neutral"
                        icon="â°"
                    />
                </div>

                {/* ğŸ® ì•¡ì…˜ ë²„íŠ¼ë“¤ */}
                <YagoCard title="ğŸ® AI ì¸ì‚¬ì´íŠ¸ ìƒì„±" icon="âš™ï¸">
                    <div className="flex flex-wrap gap-4">
                        <YagoButton
                            text={loading ? "ğŸ§  AI ë¶„ì„ ì¤‘..." : "ğŸ§  ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ ìƒì„±"}
                            onClick={generateInsight}
                            variant="primary"
                            icon="ğŸ§ "
                            loading={loading}
                            disabled={loading || !agg || agg.total === 0}
                        />
                        <YagoButton
                            text={slackLoading ? "ğŸ“± ê³µìœ  ì¤‘..." : "ğŸ“± Slack ê³µìœ "}
                            onClick={shareToSlack}
                            variant="accent"
                            icon="ğŸ“±"
                            loading={slackLoading}
                            disabled={slackLoading || !insight}
                        />
                        <YagoButton
                            text="ğŸ”„ ìƒˆë¡œê³ ì¹¨"
                            onClick={() => window.location.reload()}
                            variant="outline"
                            icon="ğŸ”„"
                        />
                    </div>
                    <div className="mt-4 text-sm text-yago-gray">
                        {agg && agg.total === 0 ? (
                            <span className="text-orange-600">âš ï¸ ì˜¤ëŠ˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìŒì„± ëª…ë ¹ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.</span>
                        ) : (
                            <span>âœ… {agg?.total || 0}ê±´ì˜ ë¡œê·¸ ë°ì´í„°ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                        )}
                    </div>
                </YagoCard>

                {/* ğŸ§  AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ */}
                <YagoCard title="ğŸ§  AI ìƒì„± ì¸ì‚¬ì´íŠ¸" icon="ğŸ¤–" gradient>
                    {insight ? (
                        <div className="space-y-4">
                            <div className="bg-white/20 rounded-xl p-4">
                                <h3 className="text-xl font-semibold text-white mb-3">
                                    {insight.headline}
                                </h3>
                                <ul className="space-y-2 text-white/90">
                                    {insight.bullets.map((bullet, i) => (
                                        <li key={i} className="flex items-start gap-2">
                                            <span className="text-yago-pink mt-1">â€¢</span>
                                            <span>{bullet}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                            <div className="bg-white/20 rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-yago-pink">â¡ï¸</span>
                                    <span className="font-semibold text-white">Action</span>
                                </div>
                                <p className="text-white/90">{insight.action}</p>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <div className="text-6xl mb-4">ğŸ¤–</div>
                            <p className="text-white/80 text-lg mb-2">
                                AI ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                            </p>
                            <p className="text-white/60 text-sm">
                                GPT-4o-miniê°€ ì˜¤ëŠ˜ì˜ ë¡œê·¸ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤
                            </p>
                        </div>
                    )}
                </YagoCard>

                {/* ğŸ“Š ìƒì„¸ ì§‘ê³„ ë·° */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* ì˜ë„ë³„ í†µê³„ */}
                    <YagoCard title="ğŸ“Š ì˜ë„ë³„ ë¶„í¬" icon="ğŸ¯">
                        <div className="space-y-3">
                            {Object.entries(agg?.intents || {})
                                .sort((a, b) => (b[1] as number) - (a[1] as number))
                                .slice(0, 8)
                                .map(([intent, count]) => (
                                    <div key={intent} className="flex items-center justify-between p-3 bg-yago-soft rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <span className="px-2 py-1 bg-yago-purple text-white text-xs font-semibold rounded-full">
                                                {intent}
                                            </span>
                                        </div>
                                        <span className="px-3 py-1 bg-yago-purple text-white text-sm font-semibold rounded-full">
                                            {count as number}íšŒ
                                        </span>
                                    </div>
                                ))}
                        </div>
                    </YagoCard>

                    {/* í‚¤ì›Œë“œë³„ í†µê³„ */}
                    <YagoCard title="ğŸ”¥ í‚¤ì›Œë“œë³„ ë¶„í¬" icon="ğŸ”¥">
                        <div className="space-y-3">
                            {Object.entries(agg?.keywords || {})
                                .sort((a, b) => (b[1] as number) - (a[1] as number))
                                .slice(0, 8)
                                .map(([keyword, count]) => (
                                    <div key={keyword} className="flex items-center justify-between p-3 bg-yago-soft rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <span className="px-2 py-1 bg-yago-pink text-white text-xs font-semibold rounded-full">
                                                {keyword}
                                            </span>
                                        </div>
                                        <span className="px-3 py-1 bg-yago-pink text-white text-sm font-semibold rounded-full">
                                            {count as number}íšŒ
                                        </span>
                                    </div>
                                ))}
                        </div>
                    </YagoCard>

                    {/* ì‹œê°„ëŒ€ë³„ í†µê³„ */}
                    <YagoCard title="â° ì‹œê°„ëŒ€ë³„ ë¶„í¬" icon="â°">
                        <div className="space-y-3">
                            {Object.entries(agg?.hours || {})
                                .sort((a, b) => (b[1] as number) - (a[1] as number))
                                .slice(0, 8)
                                .map(([hour, count]) => (
                                    <div key={hour} className="flex items-center justify-between p-3 bg-yago-soft rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <span className="px-2 py-1 bg-yago-blue text-white text-xs font-semibold rounded-full">
                                                {hour}:00
                                            </span>
                                        </div>
                                        <span className="px-3 py-1 bg-yago-blue text-white text-sm font-semibold rounded-full">
                                            {count as number}íšŒ
                                        </span>
                                    </div>
                                ))}
                        </div>
                    </YagoCard>
                </div>

                {/* ğŸš€ ë¹ ë¥¸ ë§í¬ */}
                <YagoCard title="ğŸš€ ë¹ ë¥¸ ë§í¬" icon="ğŸ”—" gradient>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <a
                            href="/admin"
                            className="p-4 bg-white/20 rounded-xl text-center hover:bg-white/30 transition-colors"
                        >
                            <div className="text-2xl mb-2">ğŸ“Š</div>
                            <div className="text-sm font-medium">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</div>
                        </a>
                        <a
                            href="/admin/geo"
                            className="p-4 bg-white/20 rounded-xl text-center hover:bg-white/30 transition-colors"
                        >
                            <div className="text-2xl mb-2">ğŸ“</div>
                            <div className="text-sm font-medium">Geo Analytics</div>
                        </a>
                        <a
                            href="/voice-map-dashboard"
                            className="p-4 bg-white/20 rounded-xl text-center hover:bg-white/30 transition-colors"
                        >
                            <div className="text-2xl mb-2">ğŸ“</div>
                            <div className="text-sm font-medium">ë¡œê·¸ ëŒ€ì‹œë³´ë“œ</div>
                        </a>
                        <a
                            href="/voice"
                            className="p-4 bg-white/20 rounded-xl text-center hover:bg-white/30 transition-colors"
                        >
                            <div className="text-2xl mb-2">ğŸ—ºï¸</div>
                            <div className="text-sm font-medium">ìŒì„± ì§€ë„</div>
                        </a>
                    </div>
                </YagoCard>
            </div>
        </YagoLayout>
    );
}
