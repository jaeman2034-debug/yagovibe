import OpenAI from "openai";
import { aggregateLogs } from "@/utils/aggregateLogs";
import { PDFDocument, rgb, StandardFonts } from "pdf-lib";
import { db } from "@/lib/firebase";
import { addDoc, collection, serverTimestamp } from "firebase/firestore";

const client = new OpenAI({ apiKey: import.meta.env.VITE_OPENAI_API_KEY });

export const POST = async () => {
    try {
        console.log("ðŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì‹œìž‘...");

        // Slack URL ë¨¼ì € ì„ ì–¸ (ë‚˜ì¤‘ì— ì‚¬ìš©ë¨)
        const slackUrl = import.meta.env.VITE_SLACK_WEBHOOK_URL;

        const logs = await aggregateLogs();
        console.log("ðŸ“ˆ ì§‘ê³„ëœ ë¡œê·¸ ë°ì´í„°:", {
            total: logs.total,
            geoSample: logs.geoSample?.length || 0,
            devices: Object.keys(logs.devices || {}).length,
            actions: Object.keys(logs.actions || {}).length
        });

        const prompt = `
ë„ˆëŠ” ë°ì´í„° ë¶„ì„ê°€ì•¼. ë‹¤ìŒ ë¡œê·¸ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ
ì£¼ê°„ í™œë™ ë¦¬í¬íŠ¸ë¥¼ ìž‘ì„±í•´.
í˜•ì‹ì€ ë°˜ë“œì‹œ JSONë§Œ ë°˜í™˜í•´.

{
  "summary": "ì£¼ê°„ í™œë™ ìš”ì•½ (í•œ ì¤„)",
  "insights": [
    "ì£¼ìš” ë°œê²¬ì‚¬í•­ 1",
    "ì£¼ìš” ë°œê²¬ì‚¬í•­ 2", 
    "ì£¼ìš” ë°œê²¬ì‚¬í•­ 3"
  ],
  "recommendations": [
    "ê°œì„  ì¶”ì²œ 1",
    "ê°œì„  ì¶”ì²œ 2",
    "ê°œì„  ì¶”ì²œ 3"
  ],
  "metrics": {
    "totalLogs": ${logs.total || 0},
    "geoCount": ${logs.geoSample?.length || 0},
    "deviceTypes": ${Object.keys(logs.devices || {}).length},
    "actionTypes": ${Object.keys(logs.actions || {}).length}
  }
}

ë¡œê·¸ ë°ì´í„°:
- ì´ ë¡œê·¸ ìˆ˜: ${logs.total || 0}ê±´
- ìœ„ì¹˜ ìƒ˜í”Œ: ${logs.geoSample?.length || 0}ê°œ
- ë””ë°”ì´ìŠ¤ ì¢…ë¥˜: ${Object.keys(logs.devices || {}).length}ê°œ
- ì•¡ì…˜ ì¢…ë¥˜: ${Object.keys(logs.actions || {}).length}ê°œ

ìƒì„¸ ë°ì´í„°: ${JSON.stringify(logs).slice(0, 6000)}

ë¶„ì„ í¬ì¸íŠ¸:
1. ì‚¬ìš© íŒ¨í„´ê³¼ íŠ¸ë Œë“œ
2. ì£¼ìš” í™œë™ ìœ í˜•
3. ê°œì„  ê°€ëŠ¥í•œ ì˜ì—­
4. ì‚¬ìš©ìž í–‰ë™ ì¸ì‚¬ì´íŠ¸
5. ì£¼ê°„ ì„±ê³¼ ì§€í‘œ
`;

        const response = await client.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            response_format: { type: "json_object" },
            temperature: 0.7,
            max_tokens: 1500
        });

        const report = JSON.parse(response.choices[0].message?.content || "{}");
        console.log("âœ… AI ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ:", report);

        // PDF ìƒì„±
        const pdf = await PDFDocument.create();
        const page = pdf.addPage([595.28, 841.89]);
        const { width, height } = page.getSize();
        const font = await pdf.embedFont(StandardFonts.Helvetica);
        const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);

        let y = height - 60;
        const drawText = (text: string, size = 14, gap = 20, isBold = false) => {
            page.drawText(text, {
                x: 50,
                y,
                size,
                font: isBold ? boldFont : font,
                color: rgb(0.2, 0.2, 0.2)
            });
            y -= gap;
        };

        // í—¤ë”
        drawText("ðŸ“Š YAGO VIBE - ì£¼ê°„ AI ë¦¬í¬íŠ¸", 20, 30, true);
        drawText(`ìž‘ì„±ì¼: ${new Date().toLocaleString("ko-KR")}`, 12, 20);
        drawText("â”€".repeat(50), 12, 20);

        // ìš”ì•½
        drawText("ðŸ“‹ ì£¼ê°„ í™œë™ ìš”ì•½", 16, 25, true);
        drawText(report.summary || "ë°ì´í„° ë¶„ì„ ì¤‘...", 12, 20);

        // ì§€í‘œ
        drawText("ðŸ“ˆ ì£¼ìš” ì§€í‘œ", 16, 25, true);
        if (report.metrics) {
            drawText(`â€¢ ì´ ë¡œê·¸ ìˆ˜: ${report.metrics.totalLogs || 0}ê±´`, 12, 18);
            drawText(`â€¢ ìœ„ì¹˜ ìƒ˜í”Œ: ${report.metrics.geoCount || 0}ê°œ`, 12, 18);
            drawText(`â€¢ ë””ë°”ì´ìŠ¤ ìœ í˜•: ${report.metrics.deviceTypes || 0}ê°œ`, 12, 18);
            drawText(`â€¢ ì•¡ì…˜ ìœ í˜•: ${report.metrics.actionTypes || 0}ê°œ`, 12, 18);
        }

        // ì¸ì‚¬ì´íŠ¸
        drawText("ðŸ” ì£¼ìš” ì¸ì‚¬ì´íŠ¸", 16, 25, true);
        if (report.insights && Array.isArray(report.insights)) {
            report.insights.forEach((insight: string) => {
                drawText(`â€¢ ${insight}`, 12, 18);
            });
        } else {
            drawText("â€¢ ë°ì´í„° ë¶„ì„ ì¤‘...", 12, 18);
        }

        // ì¶”ì²œì‚¬í•­
        drawText("ðŸŽ¯ ê°œì„  ì¶”ì²œ", 16, 25, true);
        if (report.recommendations && Array.isArray(report.recommendations)) {
            report.recommendations.forEach((rec: string) => {
                drawText(`â€¢ ${rec}`, 12, 18);
            });
        } else {
            drawText("â€¢ ë¶„ì„ ì¤‘...", 12, 18);
        }

        // í‘¸í„°
        y = 50;
        drawText("â”€".repeat(50), 12, 20);
        drawText("Generated by YAGO VIBE AI System", 10, 15);
        drawText(`Report ID: ${Date.now()}`, 10, 15);

        const pdfBytes = await pdf.save();
        console.log("ðŸ“„ PDF ìƒì„± ì™„ë£Œ:", pdfBytes.length, "bytes");

        // Firestoreì— ë¦¬í¬íŠ¸ ë©”íƒ€ë°ì´í„° ì €ìž¥
        try {
            const reportDate = new Date().toISOString();
            const reportData = {
                date: reportDate,
                summary: report.summary || "ì£¼ê°„ í™œë™ ìš”ì•½",
                insights: report.insights || [],
                recommendations: report.recommendations || [],
                metrics: report.metrics || {},
                pdfUrl: `https://your-app-domain/api/generateWeeklyReport?date=${reportDate}`,
                createdAt: serverTimestamp(),
                totalLogs: logs.total || 0,
                geoCount: logs.geoSample?.length || 0,
                deviceTypes: Object.keys(logs.devices || {}).length,
                actionTypes: Object.keys(logs.actions || {}).length,
                slackSent: !!slackUrl,
                status: "completed"
            };

            await addDoc(collection(db, "weekly_reports"), reportData);
            console.log("âœ… Firestore ì €ìž¥ ì™„ë£Œ:", reportData);
        } catch (firestoreError) {
            console.warn("âš ï¸ Firestore ì €ìž¥ ì‹¤íŒ¨:", firestoreError);
        }

        // Slack ì „ì†¡ (ì„ íƒì‚¬í•­)
        if (slackUrl) {
            try {
                await fetch(slackUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        text: `ðŸ“ˆ *YAGO VIBE ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ*\nðŸ“… ${new Date().toLocaleDateString("ko-KR")}\nðŸ“Š ì´ ${logs.total || 0}ê±´ì˜ ë¡œê·¸ ë¶„ì„ ì™„ë£Œ`,
                        blocks: [
                            {
                                type: "header",
                                text: {
                                    type: "plain_text",
                                    text: "ðŸ“ˆ YAGO VIBE ì£¼ê°„ ë¦¬í¬íŠ¸"
                                }
                            },
                            {
                                type: "section",
                                text: {
                                    type: "mrkdwn",
                                    text: `ðŸ“… *ìž‘ì„±ì¼:* ${new Date().toLocaleDateString("ko-KR")}\nðŸ“Š *ì´ ë¡œê·¸:* ${logs.total || 0}ê±´\nðŸŒ *ì§€ì—­ ìƒ˜í”Œ:* ${logs.geoSample?.length || 0}ê°œ`
                                }
                            },
                            {
                                type: "section",
                                text: {
                                    type: "mrkdwn",
                                    text: `*ì£¼ìš” ìš”ì•½:*\n${report.summary || "ë°ì´í„° ë¶„ì„ ì¤‘..."}`
                                }
                            }
                        ]
                    })
                });
                console.log("âœ… Slack ì „ì†¡ ì™„ë£Œ");
            } catch (slackError) {
                console.warn("âš ï¸ Slack ì „ì†¡ ì‹¤íŒ¨:", slackError);
            }
        }

        // Uint8Arrayë¥¼ Bufferë¡œ ë³€í™˜í•˜ì—¬ Response ìƒì„±
        return new Response(Buffer.from(pdfBytes), {
            headers: {
                "Content-Type": "application/pdf",
                "Content-Disposition": `attachment; filename=YAGO_VIBE_Weekly_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "POST, OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type"
            },
        });

    } catch (err) {
        console.error("âŒ ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜:", err);

        // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ PDF ìƒì„±
        try {
            const pdf = await PDFDocument.create();
            const page = pdf.addPage([595.28, 841.89]);
            const font = await pdf.embedFont(StandardFonts.Helvetica);

            page.drawText("âŒ YAGO VIBE ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜", {
                x: 50,
                y: 750,
                size: 16,
                font,
                color: rgb(0.8, 0.2, 0.2)
            });

            page.drawText(`ì˜¤ë¥˜ ë°œìƒ: ${err instanceof Error ? err.message : 'Unknown error'}`, {
                x: 50,
                y: 700,
                size: 12,
                font,
                color: rgb(0.4, 0.4, 0.4)
            });

            page.drawText(`ë°œìƒ ì‹œê°„: ${new Date().toLocaleString("ko-KR")}`, {
                x: 50,
                y: 650,
                size: 10,
                font,
                color: rgb(0.4, 0.4, 0.4)
            });

            const pdfBytes = await pdf.save();

            return new Response(Buffer.from(pdfBytes), {
                status: 500,
                headers: {
                    "Content-Type": "application/pdf",
                    "Content-Disposition": `attachment; filename=YAGO_VIBE_Error_Report_${new Date().toISOString().split('T')[0]}.pdf`
                }
            });
        } catch (pdfError) {
            console.error("âŒ PDF ìƒì„±ë„ ì‹¤íŒ¨:", pdfError);
            return new Response("Internal Server Error", { status: 500 });
        }
    }
};

// CORS preflight ìš”ì²­ ì²˜ë¦¬
export const OPTIONS = async () => {
    return new Response(null, {
        status: 200,
        headers: {
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "POST, OPTIONS",
            "Access-Control-Allow-Headers": "Content-Type"
        }
    });
};
