name: ğŸš€ YAGO VIBE CI/CD Pipeline

on:
  push:
    branches:
      - main      # Production ë°°í¬
      - dev       # Preview ë°°í¬
      - 'feature/**'  # Feature ë¸Œëœì¹˜ Preview ë°°í¬
  pull_request:
    branches:
      - main
      - dev

jobs:
  # ì½”ë“œ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸
  lint-and-test:
    name: ğŸ” Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” Lint ê²€ì‚¬
        run: npm run lint
        continue-on-error: true

      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test --if-present
        continue-on-error: true

      - name: ğŸ”§ ë¹Œë“œ ê²€ì‚¬
        run: npm run check:build
        continue-on-error: true

  # Vercel ë°°í¬ (Preview)
  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: |
      (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/feature/**' || github.event_name == 'pull_request') &&
      github.event_name != 'push' || github.ref != 'refs/heads/main'
    steps:
      - name: ğŸš€ Vercel Preview ë°°í¬ íŠ¸ë¦¬ê±°
        if: env.VERCEL_PREVIEW_HOOK != ''
        env:
          VERCEL_PREVIEW_HOOK: ${{ secrets.VERCEL_PREVIEW_HOOK }}
        run: |
          if [ -n "$VERCEL_PREVIEW_HOOK" ]; then
            echo "ğŸš€ Preview ë°°í¬ íŠ¸ë¦¬ê±° ì¤‘..."
            curl -X POST "$VERCEL_PREVIEW_HOOK" || true
          else
            echo "âš ï¸ VERCEL_PREVIEW_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Vercel Git Integrationì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤."
          fi

      - name: ğŸ“ ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "âœ… Preview ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ"
          echo "   ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "   ì´ë²¤íŠ¸: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "   PR: #${{ github.event.pull_request.number }}"
          fi

  # Vercel ë°°í¬ (Production)
  deploy-production:
    name: ğŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸš€ Vercel Production ë°°í¬ íŠ¸ë¦¬ê±°
        if: env.VERCEL_PRODUCTION_HOOK != ''
        env:
          VERCEL_PRODUCTION_HOOK: ${{ secrets.VERCEL_PRODUCTION_HOOK }}
        run: |
          if [ -n "$VERCEL_PRODUCTION_HOOK" ]; then
            echo "ğŸš€ Production ë°°í¬ íŠ¸ë¦¬ê±° ì¤‘..."
            curl -X POST "$VERCEL_PRODUCTION_HOOK" || true
          else
            echo "âš ï¸ VERCEL_PRODUCTION_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Vercel Git Integrationì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤."
          fi

      - name: ğŸ“ ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "âœ… Production ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ"
          echo "   ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "   í™˜ê²½: production"

  # Firebase Functions ë°°í¬ (Productionë§Œ)
  deploy-functions:
    name: ğŸ”¥ Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: ğŸ” Firebase ì¸ì¦
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        if: env.FIREBASE_SERVICE_ACCOUNT != ''

      - name: ğŸ”§ Firebase CLI ì„¤ì¹˜
        run: npm install -g firebase-tools

      - name: ğŸ“¦ Functions ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: functions
        run: npm ci

      - name: ğŸ—ï¸ Functions ë¹Œë“œ
        working-directory: functions
        run: npm run build

      - name: ğŸš€ Functions ë°°í¬
        working-directory: functions
        run: |
          if [ -n "$FIREBASE_TOKEN" ]; then
            firebase deploy --only functions --token "$FIREBASE_TOKEN" --non-interactive
          else
            echo "âš ï¸ FIREBASE_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "   GitHub Secretsì— FIREBASE_TOKENì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•˜ì„¸ìš”."
          fi
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: âœ… ë°°í¬ ì™„ë£Œ
        run: |
          echo "âœ… Firebase Functions ë°°í¬ ì™„ë£Œ!"
          echo "   ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "   í™˜ê²½: production"

