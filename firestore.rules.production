rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ›’ ë§ˆì¼“ ìƒí’ˆ (Market Products) - Production ë³´ì•ˆ ê·œì¹™
    match /marketProducts/{productId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì ëª¨ë‘ ê°€ëŠ¥ (ìƒí’ˆ ëª©ë¡/ìƒì„¸)
      allow read: if request.auth != null;
      
      // ìƒì„±: ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
      allow create: if request.auth != null && 
                     request.resource.data.sellerId == request.auth.uid;
      
      // ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ë§Œ ê°€ëŠ¥
      allow update, delete: if request.auth != null && 
                             resource.data.sellerId == request.auth.uid;
    }
    
    // ğŸ‘¤ ì‚¬ìš©ì í”„ë¡œí•„
    match /users/{userId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ì¸ì¦ëœ ì‚¬ìš©ì (ê³µê°œ í”„ë¡œí•„)
      allow read: if request.auth != null;
      
      // ì“°ê¸°: ë³¸ì¸ë§Œ ê°€ëŠ¥
      allow write: if request.auth != null && 
                    request.auth.uid == userId;
    }
    
    // ğŸ“Š íŒë§¤ì í”„ë¡œí•„
    match /sellerProfiles/{sellerId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì ëª¨ë‘ ê°€ëŠ¥
      allow read: if request.auth != null;
      
      // ì“°ê¸°: ë³¸ì¸ë§Œ ê°€ëŠ¥ (ë˜ëŠ” Functionsì—ì„œ)
      allow write: if request.auth != null && 
                    request.auth.uid == sellerId;
    }
    
    // ğŸ’¬ ì±„íŒ…
    match /chats/{chatId} {
      // ì½ê¸°: ì°¸ì—¬ìë§Œ ê°€ëŠ¥
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.buyerId ||
        request.auth.uid == resource.data.sellerId
      );
      
      // ìƒì„±: ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
      allow create: if request.auth != null;
      
      // ìˆ˜ì •/ì‚­ì œ: ì°¸ì—¬ìë§Œ ê°€ëŠ¥
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.buyerId ||
        request.auth.uid == resource.data.sellerId
      );
      
      // ë©”ì‹œì§€
      match /messages/{messageId} {
        // ì½ê¸°/ì“°ê¸°: ì±„íŒ… ì°¸ì—¬ìë§Œ ê°€ëŠ¥
        allow read, write: if request.auth != null && (
          request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.buyerId ||
          request.auth.uid == get(/databases/$(database)/documents/chats/$(chatId)).data.sellerId
        );
      }
    }
    
    // â¤ï¸ ì°œ ëª©ë¡
    match /favorites/{favoriteId} {
      // ì½ê¸°/ì“°ê¸°: ë³¸ì¸ë§Œ ê°€ëŠ¥
      allow read, write: if request.auth != null && 
                         request.auth.uid == resource.data.userId;
    }
    
    // ğŸ“ ì‹ ê³ 
    match /reports/{reportId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.reporterId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      
      // ìƒì„±: ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
      allow create: if request.auth != null && 
                     request.resource.data.reporterId == request.auth.uid;
      
      // ìˆ˜ì •/ì‚­ì œ: ê´€ë¦¬ìë§Œ ê°€ëŠ¥
      allow update, delete: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    // ğŸ“Š AI ë¦¬í¬íŠ¸
    match /aiReports/{reportId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì ëª¨ë‘ ê°€ëŠ¥
      allow read: if request.auth != null;
      
      // ì“°ê¸°: Functionsì—ì„œë§Œ ê°€ëŠ¥
      allow write: if false;
    }
    
    // íŒ€ ë¬¸ì„œ: íŒ€ ë©¤ë²„ë§Œ ì½ê¸° ê°€ëŠ¥, Ownerë§Œ ì“°ê¸° ê°€ëŠ¥
    match /teams/{teamId} {
      // ì½ê¸°: íŒ€ ë©¤ë²„ (owners, coaches, members) ë˜ëŠ” ê´€ë¦¬ì
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.get('owners', []) ||
        request.auth.uid in resource.data.get('coaches', []) ||
        request.auth.uid in resource.data.get('members', []) ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      
      // ì“°ê¸°: Ownerë§Œ ê°€ëŠ¥
      allow write: if request.auth != null && 
                     request.auth.uid in resource.data.get('owners', []);
      
      // íŒ€ ë¦¬í¬íŠ¸
      match /reports/{reportId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('owners', []);
        
        // í’ˆì§ˆ ë¦¬í¬íŠ¸
        match /qualityReports/{qualityReportId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null;
          allow update, delete: if false; // Functionsì—ì„œë§Œ ê´€ë¦¬
        }
      }
      
      // ì—­í•  ê´€ë¦¬
      match /roles/{userId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('owners', []);
      }
      
      // ì•Œë¦¼ ë¡œê·¸: Owner ë° ê´€ë¦¬ìë§Œ ì½ê¸° ê°€ëŠ¥
      match /alerts/{alertId} {
        allow read: if request.auth != null && (
          request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('owners', []) ||
          request.auth.token.email.matches('.*@yagovibe\\.com$') ||
          request.auth.token.email.matches('.*admin.*')
        );
        allow write: if false; // Functionsì—ì„œë§Œ ì“°ê¸°
      }
    }
    
    // ê¸°íƒ€ ê´€ë¦¬ì ì „ìš© ì»¬ë ‰ì…˜ë“¤...
    match /insightSubs/{subId} {
      allow read: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /insights/{insightId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /insightReports/{reportId} {
      allow read: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('owners', []) ||
        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('coaches', []) ||
        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('members', []) ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      
      allow update: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('owners', []) ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      
      allow create: if false;
      allow delete: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    // ê°ì‚¬ ë¡œê·¸ (Audit Logs)
    match /auditLogs/{logId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow create: if request.auth != null && 
                       request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    // ì›Œí¬í”Œë¡œìš° ë¡œê·¸ (Workflow Logs)
    match /workflowLogs/{logId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "manager" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }

    match /workflowStats/{statId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "manager" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }

    // ë² íƒ€ í”¼ë“œë°± (Beta Feedback)
    match /betaFeedback/{feedbackId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "manager" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }

    match /releaseChecks/{checkId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "manager" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }

    match /releaseNotes/{noteId} {
      allow read: if request.auth != null && (
        request.auth.token.role == "admin" ||
        request.auth.token.role == "manager" ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /modelCards/{cardId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    // Compliance Export & DSAR
    match /complianceExports/{exportId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /dsarRequests/{requestId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /deletionRequests/{requestId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.uid ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /systemLogs/{logId} {
      allow read: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /policies/{policyId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /orgs/{orgId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /tenants/{tenantId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /plans/{planId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /usage/{day}/{orgId} {
      allow read: if request.auth != null && (
        request.auth.uid == orgId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /ratelimits/{limitId} {
      allow read: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /billingDaily/{billId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.orgId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /featureOverrides/{orgId} {
      allow read: if request.auth != null && (
        request.auth.uid == orgId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /events/{day}/{eventId} {
      allow read: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /telemetryDaily/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /improvements/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
    }
    
    match /pilotRollbacks/{docId} {
      allow read: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
    
    match /_health/{docId} {
      allow read, write: if request.auth != null;
    }
    
    match /runbookTemplates/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.role in ['owner', 'admin']
      );
    }
    
    match /launchPlans/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.role in ['owner', 'admin']
      );
    }
    
    match /slo/{metricId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.role in ['owner', 'admin']
      );
    }
    
    match /experiments/{expId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.role in ['owner', 'admin']
      );
      
      match /assign/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          request.auth.token.email.matches('.*@yagovibe\\.com$') ||
          request.auth.token.email.matches('.*admin.*')
        );
        allow write: if false;
      }
    }
    
    match /sessions/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if request.auth != null && request.auth.uid == userId;
      
      match /visits/{visitId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    match /retention/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /plugins/{pluginId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*') ||
        request.auth.token.role in ['owner', 'admin'] ||
        request.auth.uid == request.resource.data.ownerId
      );
    }
    
    match /assistantLogs/{logId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.auth.token.email.matches('.*@yagovibe\\.com$') ||
        request.auth.token.email.matches('.*admin.*')
      );
      allow write: if false;
    }
  }
}

