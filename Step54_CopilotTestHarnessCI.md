# Step 54: Copilot í…ŒìŠ¤íŠ¸ í•˜ë‹ˆìŠ¤ + íšŒê·€ í…ŒìŠ¤íŠ¸ CI

Copilot(ìŒì„±/í…ìŠ¤íŠ¸ ëª…ë ¹) ì‹œìŠ¤í…œì˜ ëŒ€í™” ì‹œë‚˜ë¦¬ì˜¤, ìŠ¹ì¸ íë¦„, ê¶Œí•œ ê²€ì¦ì„ ìë™ í…ŒìŠ¤íŠ¸í•˜ëŠ” QA í•˜ë‹ˆìŠ¤ì™€ CI íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•˜ì—¬ ë°°í¬ ì „ ë¦¬ê·¸ë ˆì…˜ì„ ë°©ì§€í•©ë‹ˆë‹¤.

## ğŸ“‹ ëª©í‘œ

1. Copilot Functions ìë™ í…ŒìŠ¤íŠ¸ (opsRouterV2, opsConfirm)
2. ëŒ€í™” ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ (ì˜ë„ ì¸ì‹, ìŠ¹ì¸ í”Œë¡œìš°, ë©€í‹°í„´ ëŒ€í™”)
3. ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸ (viewer, coach, owner)
4. CI íŒŒì´í”„ë¼ì¸ êµ¬ì¶• (GitHub Actions)
5. íšŒê·€ í…ŒìŠ¤íŠ¸ë¡œ ë°°í¬ ì „ ë¦¬ê·¸ë ˆì…˜ ë°©ì§€

## ğŸš€ êµ¬í˜„ ì‚¬í•­

### 1. í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±

**íŒŒì¼**: `jest.config.js`

- Jest ì„¤ì •
- TypeScript ì§€ì› (`ts-jest`)
- í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
- Firebase Emulatorì™€ ì¶©ëŒ ë°©ì§€ (`maxWorkers: 1`)

**íŒŒì¼**: `tests/setup.ts`

- Firebase Emulator í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- ì „ì—­ í…ŒìŠ¤íŠ¸ ì „ì²˜ë¦¬/í›„ì²˜ë¦¬

### 2. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì •ì˜

**íŒŒì¼**: `tests/test_scenarios.ts`

#### í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬

1. **ì˜ë„ ì¸ì‹ í…ŒìŠ¤íŠ¸**
   - íŒ€ ìš”ì•½ ìš”ì²­
   - ì´ìƒ ë¸Œë¦¬í•‘ ìš”ì²­
   - ì¬íŠœë‹ ìš”ì²­ (ìŠ¹ì¸ í•„ìš”)
   - ëª¨ë¸ ìƒíƒœ í™•ì¸
   - ëª¨ë¸ ì¬ë¡œë“œ ìš”ì²­ (ìŠ¹ì¸ í•„ìš”)
   - ì „ì²´ í†µê³„ ìš”ì²­

2. **ìŠ¹ì¸ íë¦„ í…ŒìŠ¤íŠ¸**
   - ì¬íŠœë‹ ìŠ¹ì¸ í”Œë¡œìš°
   - ì¬íŠœë‹ ê±°ë¶€ í”Œë¡œìš°

3. **ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸**
   - viewer ì—­í• : ì¬íŠœë‹ ê±°ë¶€
   - owner ì—­í• : ì¬íŠœë‹ ìŠ¹ì¸ ê°€ëŠ¥

4. **ì¿¨ë‹¤ìš´ í…ŒìŠ¤íŠ¸**
   - ë™ì¼ intent ì¬ì‹œë„ ì¿¨ë‹¤ìš´ ì°¨ë‹¨

5. **ë©€í‹°í„´ ëŒ€í™” í…ŒìŠ¤íŠ¸**
   - ì»¨í…ìŠ¤íŠ¸ ê¸°ì–µ: íŒ€ëª… ìƒëµ í›„ ì°¸ì¡°

### 3. CI íŒŒì´í”„ë¼ì¸

**íŒŒì¼**: `.github/workflows/copilot-ci.yml`

- GitHub Actions ì›Œí¬í”Œë¡œìš°
- Node.js 18.x, 20.x ë§¤íŠ¸ë¦­ìŠ¤ í…ŒìŠ¤íŠ¸
- Firebase Emulator ì‹œì‘
- í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ

## ğŸ“Š í…ŒìŠ¤íŠ¸ í•­ëª© ìš”ì•½

| ì¹´í…Œê³ ë¦¬ | ê²€ì¦ ë‚´ìš© |
|---------|----------|
| ì˜ë„ ì¸ì‹ | ì…ë ¥ í…ìŠ¤íŠ¸ â†’ ì˜¬ë°”ë¥¸ intent ì¶”ì¶œ |
| ìŠ¹ì¸ ìš”ì²­ | RISKY intent ì‹œ nonce/ë§Œë£Œ ìƒì„± í™•ì¸ |
| ê¶Œí•œ ê²€ì¦ | viewer â†’ ê¸ˆì§€, owner â†’ ìŠ¹ì¸ ê°€ëŠ¥ |
| ë¡œê·¸ ê¸°ë¡ | opsSessions/{id}/logs ì— ê¸°ë¡ ì—¬ë¶€ |
| ì¿¨ë‹¤ìš´/ë§Œë£Œ | expiresAt ì´ˆê³¼ ì‹œ ìë™ ì·¨ì†Œ ë™ì‘ |
| ë©€í‹°í„´ ëŒ€í™” | ì»¨í…ìŠ¤íŠ¸ ê¸°ì–µ ë° ì°¸ì¡° |

## ğŸ”§ ì„¤ì¹˜ ë° ì‹¤í–‰

### 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
pnpm add -D jest ts-jest @types/jest cross-fetch firebase-tools
```

### 2. ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# Firebase Emulator ì‹œì‘
firebase emulators:start --only functions,firestore

# ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pnpm test:copilot
```

### 3. CI ì‹¤í–‰

GitHubì— pushí•˜ë©´ ìë™ìœ¼ë¡œ CIê°€ ì‹¤í–‰ë©ë‹ˆë‹¤:

```bash
git push origin main
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤ 1: íŒ€ ìš”ì•½ ìš”ì²­

```typescript
{
  name: 'íŒ€ ìš”ì•½ ìš”ì²­',
  input: 'ì†Œí˜FC íŒ€ ìš”ì•½ ì•Œë ¤ì¤˜',
  expectedIntent: 'team_summary',
  teamId: 'SOHEUL_FC',
}
```

**ì˜ˆìƒ ê²°ê³¼**: 
- Intent: `team_summary`
- `needConfirm`: `false`
- ì¦‰ì‹œ ì²˜ë¦¬

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì¬íŠœë‹ ìŠ¹ì¸ í”Œë¡œìš°

```typescript
1. ìŠ¹ì¸ ìš”ì²­ â†’ nonce ë°œê¸‰
2. ìŠ¹ì¸ ì²˜ë¦¬ â†’ ì‹¤í–‰ í™•ì¸
```

**ì˜ˆìƒ ê²°ê³¼**:
- `needConfirm`: `true`
- `nonce` ë°œê¸‰
- ìŠ¹ì¸ í›„ `ok: true`

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë©€í‹°í„´ ëŒ€í™”

```typescript
1. "ì†Œí˜FC íŒ€ ìš”ì•½ ì•Œë ¤ì¤˜" â†’ teamId ì €ì¥
2. "ê·¸ íŒ€ ì¬íŠœë‹í•´" â†’ ì»¨í…ìŠ¤íŠ¸ ì°¸ì¡°
```

**ì˜ˆìƒ ê²°ê³¼**:
- ì²« ë²ˆì§¸ ëª…ë ¹: `team_summary`
- ë‘ ë²ˆì§¸ ëª…ë ¹: `retuning` (ì»¨í…ìŠ¤íŠ¸ì—ì„œ teamId ì°¸ì¡°)

## ğŸ¯ í™•ì¥ ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)

### 1. Mock STT/TTS íŒŒì´í”„ë¼ì¸

STT ê²°ê³¼ í…ìŠ¤íŠ¸ â†’ Copilot input ìë™ ì£¼ì…

```typescript
// ì˜ˆì‹œ
const sttResult = mockSTT("ì†Œí˜FC ì¬íŠœë‹í•´");
await copilot.process(sttResult);
```

### 2. í†µí•© ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰

"íŒ€ ìš”ì•½ â†’ ì¬íŠœë‹ ìš”ì²­ â†’ ìŠ¹ì¸ â†’ ì™„ë£Œ ë¸Œë¦¬í•‘" í’€ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

```typescript
test('í†µí•© ì‹œë‚˜ë¦¬ì˜¤: ì „ì²´ í”Œë¡œìš°', async () => {
  // 1) íŒ€ ìš”ì•½
  // 2) ì¬íŠœë‹ ìš”ì²­
  // 3) ìŠ¹ì¸
  // 4) ì™„ë£Œ ë¸Œë¦¬í•‘
});
```

### 3. ì˜ˆì¸¡ ì¼ì¹˜ ê²€ì¦

Step 49 ì‹œë®¬ë ˆì´ì…˜ ì ìˆ˜ì™€ ì‹¤ì œ ê²°ê³¼ ë¹„êµ â†’ Î”score í—ˆìš© ë²”ìœ„ Â±5%

```typescript
test('ì˜ˆì¸¡ ì¼ì¹˜ ê²€ì¦', async () => {
  const predicted = await getPredictedScore();
  const actual = await getActualScore();
  const diff = Math.abs(predicted - actual);
  expect(diff).toBeLessThan(0.05); // 5% í—ˆìš© ë²”ìœ„
});
```

## ğŸ“ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ì´ë“œ

### ë¡œì»¬ í…ŒìŠ¤íŠ¸

1. Firebase Emulator ì‹œì‘:
```bash
firebase emulators:start --only functions,firestore
```

2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰:
```bash
pnpm test:copilot
```

### CI í…ŒìŠ¤íŠ¸

1. GitHubì— push:
```bash
git push origin main
```

2. GitHub Actionsì—ì„œ ìë™ ì‹¤í–‰ í™•ì¸

3. í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸:
   - Actions íƒ­ì—ì„œ ê²°ê³¼ í™•ì¸
   - ì‹¤íŒ¨ ì‹œ ë¡œê·¸ í™•ì¸

## ğŸ› ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: Firebase Emulator ì—°ê²° ì‹¤íŒ¨

**ì›ì¸**: Emulatorê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```bash
# Emulator ìƒíƒœ í™•ì¸
firebase emulators:start --only functions,firestore

# í¬íŠ¸ í™•ì¸
lsof -i :5001  # Functions
lsof -i :8080  # Firestore
```

### ë¬¸ì œ 2: í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ

**ì›ì¸**: Emulator ì‹œì‘ ì‹œê°„ ë¶€ì¡±

**í•´ê²°**:
- `jest.config.js`ì—ì„œ `testTimeout` ì¦ê°€
- CIì—ì„œ `sleep 10` ì¶”ê°€

### ë¬¸ì œ 3: ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

**ì›ì¸**: Firestoreì— ì—­í•  ë°ì´í„° ì—†ìŒ

**í•´ê²°**:
- í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‹œë“œ íŒŒì¼ ìƒì„±
- Mock ë°ì´í„° ì‚¬ìš©

## ğŸ“š ë‹¤ìŒ ë‹¨ê³„

- Step 55: Mock STT/TTS íŒŒì´í”„ë¼ì¸ êµ¬í˜„
- Step 56: í†µí•© ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
- Step 57: ì˜ˆì¸¡ ì¼ì¹˜ ê²€ì¦

