const functions = require("firebase-functions");
const admin = require("firebase-admin");
const PDFDocument = require("pdfkit");
const dayjs = require("dayjs");
const axios = require("axios");
const { ChartJSNodeCanvas } = require("chartjs-node-canvas");

// Firebase Admin ì´ˆê¸°í™”
admin.initializeApp();
const db = admin.firestore();

// ğŸš€ PDF ìë™ ìƒì„± + Slack ì „ì†¡ í•¨ìˆ˜
exports.generateReport = functions.https.onRequest(async (req, res) => {
    try {
        console.log("ğŸš€ YAGO VIBE ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘");

        const today = dayjs().format("YYYY-MM-DD");
        const todayStart = dayjs().startOf('day').toDate();
        const todayEnd = dayjs().endOf('day').toDate();

        // ğŸ“Š Firestoreì—ì„œ ì˜¤ëŠ˜ ë¡œê·¸ ìˆ˜ì§‘
        const snapshot = await db.collection("voice_logs")
            .where("ts", ">=", todayStart)
            .where("ts", "<=", todayEnd)
            .get();

        const logs = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        console.log(`ğŸ“ ìˆ˜ì§‘ëœ ë¡œê·¸: ${logs.length}ê±´`);

        // ğŸ“ˆ Intent í†µê³„ ê³„ì‚°
        const intents = {};
        const keywords = {};

        logs.forEach((log) => {
            const intent = log.intent || "ë¯¸í™•ì¸";
            intents[intent] = (intents[intent] || 0) + 1;

            if (log.keyword) {
                keywords[log.keyword] = (keywords[log.keyword] || 0) + 1;
            }
        });

        console.log("ğŸ“Š Intent í†µê³„:", intents);
        console.log("ğŸ”¥ í‚¤ì›Œë“œ í†µê³„:", keywords);

        // ğŸ“Š ì°¨íŠ¸ ì´ë¯¸ì§€ ìƒì„± (Canvas ë¬¸ì œ ì‹œ í…ìŠ¤íŠ¸ ëŒ€ì²´)
        let chartBuffer;
        try {
            const chart = new ChartJSNodeCanvas({
                width: 600,
                height: 300,
                backgroundColour: 'white'
            });

            chartBuffer = await chart.renderToBuffer({
                type: "bar",
                data: {
                    labels: Object.keys(intents),
                    datasets: [
                        {
                            label: "ëª…ë ¹ íšŸìˆ˜",
                            data: Object.values(intents),
                            backgroundColor: [
                                "#6366F1",
                                "#A78BFA",
                                "#EC4899",
                                "#3B82F6",
                                "#6B7280"
                            ],
                            borderColor: "#4F46E5",
                            borderWidth: 2,
                            borderRadius: 8,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Intentë³„ ëª…ë ¹ ì‚¬ìš©ëŸ‰',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#E5E7EB' },
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        } catch (chartError) {
            console.warn("âš ï¸ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´:", chartError.message);
            chartBuffer = null;
        }

        // ğŸ“„ PDF ìƒì„±
        const doc = new PDFDocument({
            margin: 40,
            size: 'A4',
            info: {
                Title: `YAGO VIBE AI Daily Report - ${today}`,
                Author: 'YAGO VIBE AI System',
                Subject: 'AI-Powered Voice Command Analysis Report',
                Creator: 'YAGO VIBE AI System'
            }
        });

        const chunks = [];
        doc.on("data", (chunk) => chunks.push(chunk));

        doc.on("end", async () => {
            try {
                const pdfBuffer = Buffer.concat(chunks);
                console.log(`ğŸ“„ PDF ìƒì„± ì™„ë£Œ: ${pdfBuffer.length} bytes`);

                // ğŸ’¬ Slack ë©”ì‹œì§€ ì „ì†¡
                const slackWebhookUrl = process.env.SLACK_WEBHOOK_URL;
                if (slackWebhookUrl) {
                    const topIntent = Object.entries(intents).sort(([, a], [, b]) => b - a)[0];
                    const topKeyword = Object.entries(keywords).sort(([, a], [, b]) => b - a)[0];

                    const slackMessage = {
                        text: `ğŸ“„ *YAGO VIBE ì¼ì¼ ë¦¬í¬íŠ¸ (${today})*`,
                        attachments: [
                            {
                                color: "#4F46E5",
                                fields: [
                                    {
                                        title: "ğŸ“Š ì´ ëª…ë ¹ì–´",
                                        value: `${logs.length}ê±´`,
                                        short: true
                                    },
                                    {
                                        title: "ğŸ¯ ì¸ê¸° ì˜ë„",
                                        value: `${topIntent ? topIntent[0] : "ì—†ìŒ"} (${topIntent ? topIntent[1] : 0}íšŒ)`,
                                        short: true
                                    },
                                    {
                                        title: "ğŸ”¥ ì¸ê¸° í‚¤ì›Œë“œ",
                                        value: `${topKeyword ? topKeyword[0] : "ì—†ìŒ"} (${topKeyword ? topKeyword[1] : 0}íšŒ)`,
                                        short: true
                                    },
                                    {
                                        title: "ğŸ“ˆ Intent ë¶„í¬",
                                        value: Object.entries(intents)
                                            .map(([intent, count]) => `â€¢ ${intent}: ${count}íšŒ`)
                                            .join('\n'),
                                        short: false
                                    }
                                ],
                                footer: "YAGO VIBE AI System",
                                ts: Math.floor(Date.now() / 1000)
                            }
                        ]
                    };

                    await axios.post(slackWebhookUrl, slackMessage);
                    console.log("ğŸ’¬ Slack ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
                }

                // ğŸ“ Slack íŒŒì¼ ì—…ë¡œë“œ (Bot Token ë°©ì‹)
                const slackBotToken = process.env.SLACK_BOT_TOKEN;
                if (slackBotToken) {
                    const FormData = require('form-data');
                    const form = new FormData();

                    form.append('token', slackBotToken);
                    form.append('channels', '#daily-reports');
                    form.append('file', pdfBuffer, {
                        filename: `YAGO_VIBE_Report_${today}.pdf`,
                        contentType: 'application/pdf'
                    });
                    form.append('title', `YAGO VIBE ì¼ì¼ ë¦¬í¬íŠ¸ - ${today}`);
                    form.append('initial_comment', `ğŸ“„ ${today} ì¼ì¼ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                    await axios.post('https://slack.com/api/files.upload', form, {
                        headers: {
                            ...form.getHeaders(),
                        },
                    });
                    console.log("ğŸ“ Slack íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ");
                }

                res.status(200).json({
                    success: true,
                    message: "âœ… ë¦¬í¬íŠ¸ ìƒì„± ë° Slack ì „ì†¡ ì™„ë£Œ",
                    data: {
                        date: today,
                        totalCommands: logs.length,
                        intents: intents,
                        keywords: keywords
                    }
                });

            } catch (slackError) {
                console.error("âŒ Slack ì „ì†¡ ì˜¤ë¥˜:", slackError);
                res.status(200).json({
                    success: true,
                    message: "âœ… PDF ìƒì„± ì™„ë£Œ (Slack ì „ì†¡ ì‹¤íŒ¨)",
                    error: slackError.message
                });
            }
        });

        // ğŸ“„ PDF ë‚´ìš© ì‘ì„±
        // í—¤ë”
        doc
            .fontSize(24)
            .fillColor("#4F46E5")
            .font("Helvetica-Bold")
            .text("YAGO VIBE AI Daily Report", { align: "center" });

        doc
            .fontSize(12)
            .fillColor("#6B7280")
            .font("Helvetica")
            .text(`ğŸ“… ${today}`, { align: "center" });

        doc.moveDown(1);

        // í†µê³„ ìš”ì•½
        doc
            .fontSize(16)
            .fillColor("#111")
            .text("ğŸ“Š ì¼ì¼ í†µê³„ ìš”ì•½", { align: "left" });

        doc
            .fontSize(12)
            .fillColor("#333")
            .text(`â€¢ ì´ ëª…ë ¹ì–´: ${logs.length}ê±´`)
            .text(`â€¢ Intent ì¢…ë¥˜: ${Object.keys(intents).length}ê°œ`)
            .text(`â€¢ í‚¤ì›Œë“œ ì¢…ë¥˜: ${Object.keys(keywords).length}ê°œ`);

        doc.moveDown(1);

        // ì°¨íŠ¸ ë˜ëŠ” í…ìŠ¤íŠ¸ í†µê³„
        if (chartBuffer) {
            doc.text("ğŸ“ˆ Intentë³„ ì‚¬ìš©ëŸ‰ ì°¨íŠ¸", { align: "left" });
            doc.image(chartBuffer, { fit: [500, 250], align: "center" });
        } else {
            doc.text("ğŸ“ˆ Intentë³„ í†µê³„ (í…ìŠ¤íŠ¸)", { align: "left" });
            Object.entries(intents).forEach(([intent, count]) => {
                doc.text(`â€¢ ${intent}: ${count}íšŒ`);
            });
        }

        doc.moveDown(1);

        // ìƒìœ„ í‚¤ì›Œë“œ
        const topKeywords = Object.entries(keywords)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        if (topKeywords.length > 0) {
            doc
                .fontSize(14)
                .fillColor("#111")
                .text("ğŸ”¥ ìƒìœ„ í‚¤ì›Œë“œ Top 5");

            topKeywords.forEach(([keyword, count], index) => {
                doc
                    .fontSize(12)
                    .fillColor("#333")
                    .text(`${index + 1}. ${keyword}: ${count}íšŒ`);
            });
        }

        doc.moveDown(2);

        // í‘¸í„°
        doc
            .fontSize(10)
            .fillColor("#6B7280")
            .text("Generated automatically by YAGO VIBE AI System", { align: "center" })
            .text(`Report generated at: ${dayjs().format('YYYY-MM-DD HH:mm:ss')}`, { align: "center" });

        doc.end();

    } catch (error) {
        console.error("âŒ í•¨ìˆ˜ ì‹¤í–‰ ì˜¤ë¥˜:", error);
        res.status(500).json({
            success: false,
            message: "âŒ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ",
            error: error.message
        });
    }
});

// ğŸ¯ í†µí•© ë¦¬í¬íŠ¸ í•¨ìˆ˜ (Slack + ì›¹ + ëª¨ë°”ì¼ ëª¨ë‘ ì§€ì›)
exports.vibeReport = functions.https.onRequest(async (req, res) => {
    try {
        console.log("ğŸ¯ YAGO VIBE í†µí•© ë¦¬í¬íŠ¸ ìš”ì²­ ì‹œì‘");

        // CORS í—¤ë” ì„¤ì •
        res.set('Access-Control-Allow-Origin', '*');
        res.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
        res.set('Access-Control-Allow-Headers', 'Content-Type');

        if (req.method === 'OPTIONS') {
            res.status(200).send('');
            return;
        }

        const { period = "thisweek", source = "web" } = req.query;
        console.log(`ğŸ“Š ë¦¬í¬íŠ¸ ìš”ì²­: ${period} (${source})`);

        // ğŸ“Š Firestoreì—ì„œ ìµœê·¼ 4ê°œ ë¦¬í¬íŠ¸ ì¡°íšŒ
        const reportsSnapshot = await db.collection("weekly_reports")
            .orderBy("createdAt", "desc")
            .limit(4)
            .get();

        const reports = reportsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        console.log(`ğŸ“‹ ì¡°íšŒëœ ë¦¬í¬íŠ¸ ìˆ˜: ${reports.length}`);

        if (reports.length === 0) {
            const errorResponse = {
                success: false,
                message: "ì•„ì§ ìƒì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ë¨¼ì € ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.",
                period,
                source
            };

            // Slack ìš”ì²­ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
            if (source === "slack") {
                const formData = req.body;
                const responseUrl = formData.response_url;

                if (responseUrl) {
                    await axios.post(responseUrl, {
                        response_type: "ephemeral",
                        text: "âŒ " + errorResponse.message
                    });
                }
            }

            res.status(200).json(errorResponse);
            return;
        }

        // ğŸ¯ ìš”ì²­ëœ ì£¼ì°¨ ë¦¬í¬íŠ¸ ì„ íƒ
        let target = reports[0]; // ê¸°ë³¸ê°’: ìµœì‹  ë¦¬í¬íŠ¸
        let reportDescription = "ì´ë²ˆ ì£¼";

        if (period.includes("lastweek") || period.includes("ì§€ë‚œì£¼") || period.includes("ì§€ë‚œ ì£¼")) {
            target = reports[1] || reports[0];
            reportDescription = "ì§€ë‚œ ì£¼";
        } else if (period.includes("2week") || period.includes("2ì£¼ì „") || period.includes("2ì£¼ ì „")) {
            target = reports[2] || reports[0];
            reportDescription = "2ì£¼ ì „";
        } else if (period.includes("3week") || period.includes("3ì£¼ì „") || period.includes("3ì£¼ ì „")) {
            target = reports[3] || reports[0];
            reportDescription = "3ì£¼ ì „";
        }

        console.log(`ğŸ¯ ì„ íƒëœ ë¦¬í¬íŠ¸: ${reportDescription} (${target.date})`);

        // ğŸ“Š ë¦¬í¬íŠ¸ ìš”ì•½ ìƒì„±
        const reportSummary = {
            period: reportDescription,
            date: target.date,
            totalLogs: target.totalLogs || 0,
            geoCount: target.geoCount || 0,
            deviceTypes: target.deviceTypes || 0,
            actionTypes: target.actionTypes || 0,
            insights: target.insights || [],
            recommendations: target.recommendations || [],
            summary: target.summary || "ìš”ì•½ ì—†ìŒ"
        };

        // ğŸ“± Slack ìš”ì²­ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
        if (source === "slack") {
            const formData = req.body;
            const responseUrl = formData.response_url;
            const userName = formData.user_name;

            if (responseUrl) {
                const slackMessage = {
                    response_type: "in_channel",
                    text: `ğŸ“Š *YAGO VIBE ${reportDescription} ë¦¬í¬íŠ¸*`,
                    attachments: [
                        {
                            color: "#4F46E5",
                            fields: [
                                {
                                    title: "ğŸ“… ê¸°ê°„",
                                    value: `${target.date}`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“Š ì´ ë¡œê·¸",
                                    value: `${reportSummary.totalLogs}ê±´`,
                                    short: true
                                },
                                {
                                    title: "ğŸŒ ì§€ì—­ ìƒ˜í”Œ",
                                    value: `${reportSummary.geoCount}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“± ë””ë°”ì´ìŠ¤ ìœ í˜•",
                                    value: `${reportSummary.deviceTypes}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ¯ ì£¼ìš” ì¸ì‚¬ì´íŠ¸",
                                    value: reportSummary.insights.slice(0, 3)
                                        .map(insight => `â€¢ ${insight}`)
                                        .join('\n') || "ì¸ì‚¬ì´íŠ¸ ì—†ìŒ",
                                    short: false
                                },
                                {
                                    title: "ğŸ’¡ ì¶”ì²œ í–‰ë™",
                                    value: reportSummary.recommendations.slice(0, 2)
                                        .map(rec => `â€¢ ${rec}`)
                                        .join('\n') || "ì¶”ì²œì‚¬í•­ ì—†ìŒ",
                                    short: false
                                }
                            ],
                            footer: `ìš”ì²­ì: ${userName} | ìƒì„±ì¼: ${target.date}`,
                            footer_icon: "https://platform.slack-edge.com/img/default_application_icon.png"
                        }
                    ]
                };

                await axios.post(responseUrl, slackMessage);
                console.log("ğŸ’¬ Slack ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
            }
        }

        // ğŸ”¹ Slack Webhookì—ë„ ìë™ ì „ì†¡ (ì„ íƒ ì‚¬í•­)
        const slackWebhook = process.env.SLACK_WEBHOOK_URL || functions.config().slack?.webhook;
        if (slackWebhook && source !== "slack") {
            try {
                const webhookMessage = {
                    text: `ğŸ“Š *YAGO VIBE ${reportDescription} ë¦¬í¬íŠ¸*`,
                    attachments: [
                        {
                            color: "#4F46E5",
                            fields: [
                                {
                                    title: "ğŸ“… ê¸°ê°„",
                                    value: `${target.date}`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“Š ì´ ë¡œê·¸",
                                    value: `${reportSummary.totalLogs}ê±´`,
                                    short: true
                                },
                                {
                                    title: "ğŸŒ ì§€ì—­ ìƒ˜í”Œ",
                                    value: `${reportSummary.geoCount}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“± ë””ë°”ì´ìŠ¤ ìœ í˜•",
                                    value: `${reportSummary.deviceTypes}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ¯ ì£¼ìš” ì¸ì‚¬ì´íŠ¸",
                                    value: reportSummary.insights.slice(0, 3)
                                        .map(insight => `â€¢ ${insight}`)
                                        .join('\n') || "ì¸ì‚¬ì´íŠ¸ ì—†ìŒ",
                                    short: false
                                },
                                {
                                    title: "ğŸ’¡ ì¶”ì²œ í–‰ë™",
                                    value: reportSummary.recommendations.slice(0, 2)
                                        .map(rec => `â€¢ ${rec}`)
                                        .join('\n') || "ì¶”ì²œì‚¬í•­ ì—†ìŒ",
                                    short: false
                                }
                            ],
                            footer: `Firebase Functions | ìƒì„±ì¼: ${target.date}`,
                            footer_icon: "https://platform.slack-edge.com/img/default_application_icon.png"
                        }
                    ]
                };

                await axios.post(slackWebhook, webhookMessage);
                console.log("ğŸ”¹ Slack Webhook ì „ì†¡ ì™„ë£Œ");
            } catch (webhookError) {
                console.warn("âš ï¸ Slack Webhook ì „ì†¡ ì‹¤íŒ¨:", webhookError.message);
            }
        }

        // ğŸ“Š ì¼ë°˜ ì‘ë‹µ ë°˜í™˜
        res.status(200).json({
            success: true,
            message: `âœ… ${reportDescription} ë¦¬í¬íŠ¸ ì¡°íšŒ ì™„ë£Œ`,
            data: reportSummary,
            period,
            source,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error("âŒ vibeReport í•¨ìˆ˜ ì˜¤ë¥˜:", error);

        // Slack ìš”ì²­ì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡
        if (req.query.source === "slack") {
            try {
                const formData = req.body;
                const responseUrl = formData.response_url;

                if (responseUrl) {
                    await axios.post(responseUrl, {
                        response_type: "ephemeral",
                        text: "âŒ ë¦¬í¬íŠ¸ ìš”ì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                    });
                }
            } catch (slackError) {
                console.error("âŒ Slack ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", slackError);
            }
        }

        res.status(500).json({
            success: false,
            message: "âŒ ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// ğŸš€ ë…ë¦½ API ì—”ë“œí¬ì¸íŠ¸ (Slack ì—†ì´ë„ ì‚¬ìš© ê°€ëŠ¥)
exports.generateReportAPI = functions.https.onRequest(async (req, res) => {
    try {
        console.log("ğŸš€ ë…ë¦½ API ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘");

        // CORS í—¤ë” ì„¤ì •
        res.set('Access-Control-Allow-Origin', '*');
        res.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
        res.set('Access-Control-Allow-Headers', 'Content-Type');

        if (req.method === 'OPTIONS') {
            res.status(200).send('');
            return;
        }

        const { period = "thisweek", format = "json" } = req.query;
        console.log(`ğŸ“Š ë…ë¦½ API ë¦¬í¬íŠ¸ ìš”ì²­: ${period} (${format})`);

        // ğŸ“Š Firestoreì—ì„œ ìµœê·¼ 4ê°œ ë¦¬í¬íŠ¸ ì¡°íšŒ
        const reportsSnapshot = await db.collection("weekly_reports")
            .orderBy("createdAt", "desc")
            .limit(4)
            .get();

        const reports = reportsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        if (reports.length === 0) {
            res.status(200).json({
                success: false,
                message: "ì•„ì§ ìƒì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.",
                suggestion: "ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ë¨¼ì € ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."
            });
            return;
        }

        // ğŸ¯ ìš”ì²­ëœ ì£¼ì°¨ ë¦¬í¬íŠ¸ ì„ íƒ
        let target = reports[0];
        let reportDescription = "ì´ë²ˆ ì£¼";

        if (period.includes("lastweek") || period.includes("ì§€ë‚œì£¼")) {
            target = reports[1] || reports[0];
            reportDescription = "ì§€ë‚œ ì£¼";
        } else if (period.includes("2week") || period.includes("2ì£¼ì „")) {
            target = reports[2] || reports[0];
            reportDescription = "2ì£¼ ì „";
        } else if (period.includes("3week") || period.includes("3ì£¼ì „")) {
            target = reports[3] || reports[0];
            reportDescription = "3ì£¼ ì „";
        }

        // ğŸ“Š ë¦¬í¬íŠ¸ ìš”ì•½ ìƒì„±
        const reportSummary = {
            period: reportDescription,
            date: target.date,
            totalLogs: target.totalLogs || 0,
            geoCount: target.geoCount || 0,
            deviceTypes: target.deviceTypes || 0,
            actionTypes: target.actionTypes || 0,
            insights: target.insights || [],
            recommendations: target.recommendations || [],
            summary: target.summary || "ìš”ì•½ ì—†ìŒ"
        };

        // ğŸ”¹ Slack Webhook ìë™ ì „ì†¡ (ì„ íƒ ì‚¬í•­)
        const slackWebhook = process.env.SLACK_WEBHOOK_URL || functions.config().slack?.webhook;
        if (slackWebhook) {
            try {
                const webhookMessage = {
                    text: `ğŸ“Š *YAGO VIBE ${reportDescription} ë¦¬í¬íŠ¸* (ë…ë¦½ API í˜¸ì¶œ)`,
                    attachments: [
                        {
                            color: "#4F46E5",
                            fields: [
                                {
                                    title: "ğŸ“… ê¸°ê°„",
                                    value: `${target.date}`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“Š ì´ ë¡œê·¸",
                                    value: `${reportSummary.totalLogs}ê±´`,
                                    short: true
                                },
                                {
                                    title: "ğŸŒ ì§€ì—­ ìƒ˜í”Œ",
                                    value: `${reportSummary.geoCount}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ“± ë””ë°”ì´ìŠ¤ ìœ í˜•",
                                    value: `${reportSummary.deviceTypes}ê°œ`,
                                    short: true
                                },
                                {
                                    title: "ğŸ¯ ì£¼ìš” ì¸ì‚¬ì´íŠ¸",
                                    value: reportSummary.insights.slice(0, 3)
                                        .map(insight => `â€¢ ${insight}`)
                                        .join('\n') || "ì¸ì‚¬ì´íŠ¸ ì—†ìŒ",
                                    short: false
                                },
                                {
                                    title: "ğŸ’¡ ì¶”ì²œ í–‰ë™",
                                    value: reportSummary.recommendations.slice(0, 2)
                                        .map(rec => `â€¢ ${rec}`)
                                        .join('\n') || "ì¶”ì²œì‚¬í•­ ì—†ìŒ",
                                    short: false
                                }
                            ],
                            footer: `Firebase Functions ë…ë¦½ API | ìƒì„±ì¼: ${target.date}`,
                            footer_icon: "https://platform.slack-edge.com/img/default_application_icon.png"
                        }
                    ]
                };

                await axios.post(slackWebhook, webhookMessage);
                console.log("ğŸ”¹ ë…ë¦½ API Slack Webhook ì „ì†¡ ì™„ë£Œ");
            } catch (webhookError) {
                console.warn("âš ï¸ ë…ë¦½ API Slack Webhook ì „ì†¡ ì‹¤íŒ¨:", webhookError.message);
            }
        }

        // ğŸ“Š ì‘ë‹µ ë°˜í™˜
        res.status(200).json({
            success: true,
            message: `âœ… ${reportDescription} ë¦¬í¬íŠ¸ ì¡°íšŒ ì™„ë£Œ`,
            data: reportSummary,
            period,
            format,
            timestamp: new Date().toISOString(),
            api: "Firebase Functions ë…ë¦½ API"
        });

    } catch (error) {
        console.error("âŒ ë…ë¦½ API ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜:", error);
        res.status(500).json({
            success: false,
            message: "âŒ ë…ë¦½ API ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// ğŸ§ª í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
exports.testFunction = functions.https.onRequest(async (req, res) => {
    res.status(200).json({
        message: "YAGO VIBE Firebase Functions ì •ìƒ ì‘ë™",
        timestamp: new Date().toISOString(),
        environment: {
            slackWebhook: !!process.env.SLACK_WEBHOOK_URL,
            slackBotToken: !!process.env.SLACK_BOT_TOKEN
        },
        endpoints: {
            vibeReport: "Slack ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì§€ì›",
            generateReportAPI: "ë…ë¦½ API (Slack ì—†ì´ë„ ì‚¬ìš© ê°€ëŠ¥)",
            generateReport: "PDF ìƒì„± + Slack ì „ì†¡"
        }
    });
});
